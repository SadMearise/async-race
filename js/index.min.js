!function(){"use strict";class e{constructor({tagName:e="div",classNames:t=[],textContent:n="",attributes:s={}}){this.node=document.createElement(e),this.node.classList.add(...t),this.node.textContent=n,this.setAttributes(s)}destroyChildren(){[...this.node.children].forEach((e=>e.remove()))}setAttributes(e){Object.entries(e).forEach((([e,t])=>this.node.setAttribute(e,t)))}removeAttributes(e){e.forEach((e=>this.node.removeAttribute(e)))}setContent(e){this.node.textContent=e}append(...e){[...e].forEach((e=>this.node.append(e.getNode())))}addClass(e){this.node.classList.add(e)}removeClass(e){this.node.classList.remove(e)}addListener(e,t,n=!1){this.node.addEventListener(e,t,n)}destroy(){this.node.remove()}getNode(){return this.node}toggleClass(e){this.node.classList.toggle(e)}setHTML(e){this.node.innerHTML=e}toggleAttr(e){this.node.toggleAttribute(e)}}class t extends e{constructor(e,t){super({classNames:["popup"],attributes:{id:"popup"}}),this.carName=e,this.time=t,this.render(),this.open(this)}render(){const e=this.getRenderedBodyComponent();this.append(e)}getRenderedBodyComponent(){const t=new e({classNames:["popup__body"]}),n=this.getRenderedWrapperComponent();return t.append(n),t}getRenderedWrapperComponent(){const t=new e({classNames:["popup__wrapper"]}),n=this.getRenderedContentComponent();return t.append(n),t}getRenderedContentComponent(){const t=new e({classNames:["popup__content"]}),n=new e({tagName:"h3",classNames:["popup__title"],textContent:`${this.carName} went first (${this.time}s)!`}),s=new e({tagName:"button",classNames:["popup__got-it-button","btn","btn_popup"],textContent:"Ok"});return this.handleAcceptButtonListener(s),t.append(n,s),t}handleAcceptButtonListener(e){e.addListener("click",(()=>this.close(this)))}open(e){e&&(document.body.classList.add("lock"),e.addClass("open"))}close(e){e.removeClass("open"),document.body.classList.remove("lock"),this.destroy()}}const n={xmlns:"http://www.w3.org/2000/svg",attributes:{width:"201",height:"92",viewBox:"0 0 201 92",fill:"none"},path:{attributes:{d:"M115.096 9.37826C115.096 9.37826 141.719 34.1274 142.846 35.1737C144.523 35.4975 181.121 42.5667 186.839 43.7439L187.027 43.7828L194.469 53.7091L189.395 64.2919C189.395 64.2919 168.54 70.6056 168.223 70.7015C168.279 71.2821 168.376 72.2924 168.376 72.2924C168.376 78.6181 163.196 83.7646 156.828 83.7646C150.473 83.7646 145.303 78.6341 145.284 72.3234C144.251 72.3234 55.8765 72.3234 55.6099 72.3234C55.806 73.1678 55.9811 74.0182 55.9811 74.8807C55.9811 81.2033 50.8018 86.3479 44.4344 86.3479C38.0669 86.3479 32.8856 81.2043 32.8856 74.8807C32.8856 73.6735 33.121 72.4913 33.5013 71.3411C33.3665 71.3351 33.1955 71.3281 33.1955 71.3281L15.1837 67.6246L6.10284 55.1331L9.45408 42.2928C9.45408 42.2928 37.4331 35.3376 37.7047 35.2696C37.9019 35.0698 62.1524 10.4875 62.1524 10.4875L62.4864 10.1697C64.6414 8.12511 64.7531 8.11712 70.6346 7.67242C70.9867 7.65143 105.825 5.65679 105.877 5.65679C110.513 5.37399 110.966 5.44594 115.096 9.37826ZM145.922 30.0732L145.78 30.0462L145.675 29.9483C145.412 29.7054 119.377 5.69377 118.999 5.36099C113.883 0.48931 111.868 -0.298154 105.51 0.0835865L70.2583 2.09822C62.2077 2.7068 61.5859 3.2984 58.5999 6.14046L58.285 6.44026C58.0084 6.70208 48.4385 16.4005 39.6645 25.3004L34.271 30.247C34.271 30.247 5.4177 37.5341 4.85329 37.677C4.70942 38.2256 0.113677 55.8326 -9.93416e-06 56.2703C0.268613 56.6391 11.6624 72.3084 11.8797 72.6082C12.2439 72.6882 27.2466 76.0069 27.2466 76.0069L27.2777 76.3716C28.0403 85.1357 35.5769 92 44.4364 92C52.5997 92 59.7026 86.2409 61.3234 78.3063L61.4049 77.9066H140.56L140.682 78.2324C143.178 84.9188 149.667 89.4118 156.829 89.4118C165.201 89.4118 172.332 83.4688 173.785 75.2794L173.838 74.9796C173.838 74.9796 193.007 69.0157 193.417 68.8877C193.598 68.51 200.75 53.5862 201 53.0665C200.653 52.6038 190.48 39.0421 190.287 38.7852C188.48 38.2806 157.774 32.3496 145.922 30.0732ZM105.915 12.8689L66.4403 15.1403L61.2529 33.9245H127.424L105.915 12.8689ZM103.846 18.3262L114.334 28.5962H68.2894L70.5964 20.2409L103.846 18.3262Z"}}};var s,i,r,a;!function(e){e.get="GET",e.post="POST",e.delete="DELETE",e.put="PUT",e.patch="PATCH"}(s||(s={})),function(e){e.leaderboard="leaderboard",e.garage="garage"}(i||(i={})),function(e){e.started="started",e.stopped="stopped",e.drive="drive"}(r||(r={})),function(e){e.asc="ASC",e.desc="DESC"}(a||(a={}));var o={currentPage:i.garage,currentGaragePage:1,currentLeaderboardPage:1,totalGaragePages:1,totalLeaderboardPages:1,winner:!1,sortedTime:"",sortedWins:""};const d=["TO GARAGE","TO WINNERS"],c=["garage","leaderboard"];class m extends e{constructor(e){super({tagName:"header",classNames:["header"]}),this.eventEmitter=e,this.render()}render(){const t=new e({classNames:["header__container","container"]}),n=new e({classNames:["header__body"]}),s=new e({tagName:"h1",classNames:["header__title"],textContent:"ASYNC RACE"}),i=this.getRenderedNavigationMenuComponent();this.append(t),t.append(n),n.append(s,i)}getRenderedNavigationMenuComponent(){const t=new e({tagName:"nav",classNames:["header__nav","header-nav-menu"]}),n=this.getRenderedNavigationMenuListComponent();return t.append(n),t}getRenderedNavigationMenuListComponent(){const t=new e({tagName:"ul",classNames:["header-nav-menu__list"]});for(let n=0;n<d.length;n+=1){const s=new e({tagName:"li",classNames:["header-nav-menu__item"]}),i=new e({tagName:"button",classNames:["header-nav-menu__btn","btn"],textContent:d[n],attributes:{type:"button","data-page":c[n]}});s.append(i),t.append(s),this.handleNavigationButtonListener(i)}return t}handleNavigationButtonListener(e){e.addListener("click",(async()=>{const t=e.getNode().dataset.page;o.currentPage!==t&&(t===i.garage?o.currentPage=i.garage:t===i.leaderboard&&(o.currentPage=i.leaderboard),this.eventEmitter.emit("leaderboard-pagination: set visibility"),this.eventEmitter.emit("leaderboard: set visibility"),this.eventEmitter.emit("control-menu: set visibility"),this.eventEmitter.emit("garage-pagination: set visibility"),this.eventEmitter.emit("garage: set visibility"))}))}}const u="http://127.0.0.1:3000",l=`${u}/garage`,b=`${u}/engine`,h=`${u}/winners`;var g=async e=>{const t=await fetch(l,{method:s.post,body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});return await t.json()};var p=async()=>{const e=await fetch(`${l}?_page=${o.currentGaragePage}&_limit=7`,{method:s.get}),t=e.headers.get("X-Total-Count");return{cars:await e.json(),totalCars:Number(t)}};var v=async(e,t)=>{const n=await fetch(`${l}/${e}`,{method:s.put,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});return await n.json()};var C=async(e,t)=>{const n=await fetch(`${b}?id=${e}&status=${t}`,{method:s.patch});return await n.json()};const E="text",N=["control-menu__text-input"],w="color",y=["control-menu__color-input"],f={disabled:""},R={disabled:""},_={disabled:""},B=["BWM","Toyota","Tesla","Kia","Honda","Huyndai","Nissan","Porsche","Audi","Ford","Volkswagen","Mercedes-Benz","Acura","Mitsubishi","Lexus","Renault","Mazda","Cadillac","Hummer","GMC","Jeep","Lincoln","Pontiac","Dodge","Aurus","Maserati","Ferrari"],L=["Ace","378 GT Zagato","TSX","ZDX","Adler","3000 GT","Airtrek","500","AMG ONE","CLS","CLA","503","507","i8","i5","i7","Viper","Vision","Voyager","Avenger","Cherokee","Comanche","2000GT","Allex","Allion","Aviator","Blackwood","Continental","Corsair","Acadia","Canyon","Jimmy","250 GTO","296","328","718 Spyder","911","944","959","Cybertruck","Model 3","Model S","Model X","Komendant","Senat","Aries","Caliber","Caravan","Challenger","M-NV","X-NV"];var $=async(e,t)=>{const n=await fetch(`${h}/${e}`,{method:s.put,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});return await n.json()};var S=async e=>{const t=await fetch(`${h}/${e}`,{method:s.get});return await t.json()};var T=async(e,t)=>{let n=`${h}?_page=${o.currentLeaderboardPage}&_limit=10`;e&&(n+=`&_sort=${e}`),t&&(n+=`&_order=${t}`);const i=await fetch(n,{method:s.get}),r=i.headers.get("X-Total-Count");return{winners:await i.json(),totalWinners:Number(r)}};var x=[];var A=async e=>{try{const t=await fetch(`${b}?id=${e}&status=${r.drive}`,{method:s.patch});return await t.json()}catch(e){return{success:!1}}};class k extends e{constructor(e,t){super({tagName:"form",classNames:["control-menu"]}),this.eventEmitter=e,this.carsInfo=t,this.render(),this.setVisibility(this),this.subscriptionsControlMenu()}subscriptionsControlMenu(){this.eventEmitter.subscribe("control-menu: reset",(()=>{this.getNode().reset()})),this.eventEmitter.subscribe("control-menu: set visibility",(()=>this.setVisibility(this)))}setVisibility(e){e.getNode().style.display=o.currentPage===i.garage?"block":"none"}render(){this.append(this.getRenderedFormFieldCreateComponent(),this.getRenderedFormFieldUpdateComponent(),this.getRenderedFormFieldButtonsComponent())}getRenderedFormFieldCreateComponent(){const t=new e({classNames:["control-menu__form-field"]}),n=this.getRenderedCreateTextInput(),s=this.getRenderedCreateColorInput(),i=this.getRenderedCreateButton(n,s);return t.append(n,s,i),t}getRenderedCreateTextInput(){return this.createInputComponent(E,N)}getRenderedCreateColorInput(){return this.createInputComponent(w,y)}getRenderedCreateButton(e,t){const n=this.createButtonComponent("CREATE");return this.handleCreateButtonListener(n,e,t),this.subscriptionsCreateButton(n),n}handleCreateButtonListener(e,t,n){e.addListener("click",(async()=>{this.eventEmitter.emit("create-button: add disabled");const e=t.getNode().value,s=n.getNode().value;await g({name:e,color:s});const i=await p();i.cars.length&&this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("garage: rerender",JSON.stringify(i)),this.eventEmitter.emit("garage-pagination: rerender",JSON.stringify(i)),this.eventEmitter.emit("create-button: remove disabled")}))}subscriptionsCreateButton(e){this.eventEmitter.subscribe("create-button: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("create-button: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}getRenderedFormFieldUpdateComponent(){const t=new e({classNames:["control-menu__form-field"]}),n=this.getRenderedUpdateTextInput(),s=this.getRenderedUpdateColorInput(),i=this.getRenderedUpdateButton(n,s);return t.append(n,s,i),this.subscriptionsFormFieldUpdate(n,s,i),t}subscriptionsFormFieldUpdate(e,t,n){this.eventEmitter.subscribe("update-field: update values",(n=>{if(n){const s=JSON.parse(n),i=e.getNode(),r=t.getNode();i.value=s.name,r.value=s.color}})),this.eventEmitter.subscribe("update-form-field: lock",(()=>{n.setAttributes({disabled:""}),e.setAttributes({disabled:""}),t.setAttributes({disabled:""})})),this.eventEmitter.subscribe("update-form-field: unlock",(()=>{e.removeAttributes(["disabled"]),t.removeAttributes(["disabled"]),n.removeAttributes(["disabled"])}))}getRenderedUpdateTextInput(){return this.createInputComponent(E,N,R)}getRenderedUpdateColorInput(){return this.createInputComponent(w,y,_)}getRenderedUpdateButton(e,t){const n=this.createButtonComponent("UPDATE",f);return this.handleUpdateButtonListener(n,e,t),this.subscriptionsUpdateButton(n),n}handleUpdateButtonListener(e,t,n){e.addListener("click",(async()=>{const s=t.getNode().value,i=n.getNode().value,r=Number(e.getNode().dataset.id);this.eventEmitter.emit("update-form-field: lock"),await v(r,{name:s,color:i});const a=await p();this.eventEmitter.emit("control-menu: reset"),this.eventEmitter.emit("garage: rerender",JSON.stringify(a));const{wins:o,time:d}=await S(r);await $(r,{wins:o,time:d});const c=await T();this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(c))}))}subscriptionsUpdateButton(e){this.eventEmitter.subscribe("update-button: set data",(t=>{t&&e.setAttributes({"data-id":t})}))}getRenderedFormFieldButtonsComponent(){const t=new e({classNames:["control-menu__form-field"]}),n=this.getRenderedRaceButton(),s=this.getRenderedResetButton(),i=this.getRenderedGenerateButton();return t.append(n,s,i),t}getRenderedRaceButton(){let e={};this.carsInfo.cars.length||(e={disabled:""});const t=this.createButtonComponent("RACE",e);return this.handleRaceButtonListener(t),this.subscriptionsRaceButton(t),t}handleRaceButtonListener(e){e.addListener("click",(async()=>{o.winner=!1,this.eventEmitter.emit("race-button: add disabled"),this.eventEmitter.emit("create-button: add disabled"),this.eventEmitter.emit("generate-button: add disabled"),this.eventEmitter.emit("garage-pagination-prev: add disabled"),this.eventEmitter.emit("garage-pagination-next: add disabled"),this.eventEmitter.emit("update-form-field: lock");const e=await p(),t=[];for(let n=0;n<e.cars.length;n+=1)this.eventEmitter.emit(`start-engine-button${e.cars[n].id}: add disabled`),this.eventEmitter.emit(`remove-button${e.cars[n].id}: add disabled`),this.eventEmitter.emit(`select-button${e.cars[n].id}: add disabled`),t.push(C(e.cars[n].id,r.started));const n=await Promise.all(t);for(let t=0;t<n.length;t+=1){const{id:s}=e.cars[t];this.eventEmitter.emit(`race-button${s}: start animation`,JSON.stringify(n[t])),x.push(s);const i=A(s);this.eventEmitter.emit(`stop-engine-button${s}: remove disabled`),i.then((e=>{e.success||this.eventEmitter.emit(`car-animation${s}: cancel`,r.started)}))}}))}subscriptionsRaceButton(e){this.eventEmitter.subscribe("race-button: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("race-button: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}getRenderedResetButton(){const e=this.createButtonComponent("RESET",{disabled:""});return this.handleResetButtonListener(e),this.subscriptionsResetButton(e),e}handleResetButtonListener(e){e.addListener("click",(async()=>{this.eventEmitter.emit("reset-button: add disabled");const e=await p(),t=[];for(let n=0;n<e.cars.length;n+=1){const{id:s}=e.cars[n];this.eventEmitter.emit(`stop-engine-button${s}: add disabled`),t.push(C(s,r.stopped))}const n=await Promise.all(t);for(let t=0;t<n.length;t+=1){const{id:n}=e.cars[t];this.eventEmitter.emit(`car-animation${n}: cancel`,r.stopped),this.eventEmitter.emit(`start-engine-button${n}: remove disabled`),this.eventEmitter.emit(`remove-button${n}: remove disabled`),this.eventEmitter.emit(`select-button${n}: remove disabled`)}this.eventEmitter.emit("create-button: remove disabled"),this.eventEmitter.emit("generate-button: remove disabled"),this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("garage-pagination-prev: remove disabled"),this.eventEmitter.emit("garage-pagination-next: remove disabled")}))}subscriptionsResetButton(e){this.eventEmitter.subscribe("reset-button: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("reset-button: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}getRenderedGenerateButton(){const e=this.createButtonComponent("GENERATE CARS");return this.handleGenerateCarsButtonListener(e),this.subscriptionsGenerateButton(e),e}handleGenerateCarsButtonListener(e){e.addListener("click",(async()=>{e.setAttributes({disabled:""}),this.eventEmitter.emit("race-button: add disabled"),await this.generateCars();const t=await p();t.cars.length&&this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("garage: rerender",JSON.stringify(t)),this.eventEmitter.emit("garage-pagination: rerender",JSON.stringify(t)),e.removeAttributes(["disabled"]),this.eventEmitter.emit("race-button: remove disabled")}))}subscriptionsGenerateButton(e){this.eventEmitter.subscribe("generate-button: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("generate-button: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}createInputComponent(t,n,s){return new e({tagName:"input",classNames:n,attributes:{...s,type:t}})}createButtonComponent(t,n){return new e({tagName:"button",classNames:["control-menu__race-btn","btn"],textContent:t,attributes:{...n,type:"button"}})}async generateCars(){const e=[];for(let t=0;t<100;t+=1){const t=this.generateRandomCarName(),n=this.generateRandomColor();e.push(g({name:t,color:n}))}return await Promise.all(e)}generateRandomCarName(){const e=B.length-1,t=L.length-1,n=Math.ceil(Math.random()*e),s=Math.ceil(Math.random()*t);return`${B[n]} ${L[s]}`}generateRandomColor(){const e=Math.floor(256*Math.random()),t=Math.floor(256*Math.random()),n=Math.floor(256*Math.random());let s=`#${e.toString(16)}${t.toString(16)}${n.toString(16)}`;return 7!==s.length&&(s=this.generateRandomColor()),s}}class P{constructor({tagName:e="",xmlns:t="",classNames:n=[],attributes:s={}}){this.node=document.createElementNS(t,e),this.node.classList.add(...n),this.setAttributes(s)}setAttributes(e){Object.entries(e).forEach((([e,t])=>this.node.setAttribute(e,t)))}append(...e){[...e].forEach((e=>this.node.append(e.getNode())))}getNode(){return this.node}}const O={classNames:["track__car-img","car-img","car-img_size_big"],...n};var J=async e=>{const t=await fetch(`${l}/${e}`,{method:s.delete});return await t.json()};class I extends e{constructor(e,t){super({tagName:"section",classNames:["garage-section"]}),this.eventEmitter=e,this.carsInfo=t,this.render(),this.eventEmitter.subscribe("garage: rerender",(async e=>this.rerender(e))),this.setVisibility(this),this.eventEmitter.subscribe("garage: set visibility",(()=>this.setVisibility(this)))}setVisibility(e){e.getNode().style.display=o.currentPage===i.garage?"block":"none"}rerender(e){e&&(this.carsInfo=JSON.parse(e),this.destroyChildren(),this.render())}render(){const e=this.getRenderedTitleComponent(),t=this.getRenderedTracksComponent();this.append(e,t)}getRenderedTitleComponent(){const t=new e({tagName:"h2",classNames:["garage-section__title","section-title"],textContent:"Garage "});return t.append(this.createPostfixComponent()),t}createPostfixComponent(){return new e({tagName:"span",classNames:["section-title__postfix"],textContent:`[${this.carsInfo.totalCars}]`})}getRenderedTracksComponent(){const t=new e({classNames:["garage-section__tracks"]});for(let e=0;e<this.carsInfo.cars.length;e+=1){const n=this.getRenderedTrackComponent(this.carsInfo.cars[e]);t.append(n)}return t}getRenderedTrackComponent(t){const n=new e({classNames:["garage-section__track","track"],attributes:{"data-id":`${t.id}`}}),s=this.getRenderedTrackTopComponent(t),i=this.getRenderedTrackBottomComponent(t,n);return n.append(s,i),this.unsubscriptionsTrack(t.id),this.subscriptionsTrack(n,t.id),n}unsubscriptionsTrack(e){this.eventEmitter.unsubscribe(`remove-button${e}: remove car`),this.eventEmitter.unsubscribe(`select-button${e}: select car`)}subscriptionsTrack(e,t){this.eventEmitter.subscribe(`remove-button${t}: remove car`,(()=>{this.removeCar(e)})),this.eventEmitter.subscribe(`select-button${t}: select car`,(e=>{this.selectCar(e,t)}))}async removeCar(e){const t=Number(e.getNode().dataset.id);await J(t);let n=await p();n.cars.length||(this.eventEmitter.emit("race-button: add disabled"),1!==o.currentGaragePage&&(o.currentGaragePage-=1)),n=await p(),this.eventEmitter.emit("garage: rerender",JSON.stringify(n)),this.eventEmitter.emit("garage-pagination: rerender",JSON.stringify(n))}selectCar(e,t){e&&(this.eventEmitter.emit("update-field: update values",e),this.eventEmitter.emit("update-form-field: unlock"),this.eventEmitter.emit("update-button: set data",String(t)))}getRenderedTrackTopComponent(t){const n=new e({classNames:["track__top"]}),s=new e({classNames:["track__car-settings"]}),i=this.getRenderedSelectButton(t),r=this.getRenderedRemoveButton(t),a=new e({tagName:"span",classNames:["track__car-name"],textContent:`${t.name}`});return s.append(i,r),n.append(s,a),n}getRenderedSelectButton(e){const t=this.createButtonComponent("SELECT",["track__select-car-btn","btn"]);return this.handleSelectButtonListener(t,e),this.unsubscriptionsSelectButton(e.id),this.subscriptionsSelectButton(t,e.id),t}handleSelectButtonListener(e,t){e.addListener("click",(()=>{const e=JSON.stringify(t);this.eventEmitter.emit(`select-button${t.id}: select car`,e)}))}unsubscriptionsSelectButton(e){this.eventEmitter.unsubscribe(`select-button${e}: add disabled`),this.eventEmitter.unsubscribe(`select-button${e}: remove disabled`)}subscriptionsSelectButton(e,t){this.eventEmitter.subscribe(`select-button${t}: add disabled`,(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe(`select-button${t}: remove disabled`,(()=>{e.removeAttributes(["disabled"])}))}getRenderedRemoveButton(e){const t=this.createButtonComponent("REMOVE",["track__select-car-btn","btn"]);return this.handleRemoveButtonListener(t,e.id),this.unsubscriptionsRemoveButton(e.id),this.subscriptionsRemoveButton(t,e.id),t}handleRemoveButtonListener(e,t){e.addListener("click",(()=>{this.eventEmitter.emit(`remove-button${t}: remove car`),this.eventEmitter.emit(`remove-button${t}: remove car from leaderboard`)}))}unsubscriptionsRemoveButton(e){this.eventEmitter.unsubscribe(`remove-button${e}: add disabled`),this.eventEmitter.unsubscribe(`remove-button${e}: remove disabled`)}subscriptionsRemoveButton(e,t){this.eventEmitter.subscribe(`remove-button${t}: add disabled`,(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe(`remove-button${t}: remove disabled`,(()=>{e.removeAttributes(["disabled"])}))}getRenderedTrackBottomComponent(t,n){const s=new e({classNames:["track__bottom"]}),i=this.getRenderedEngineControlComponent(t),r=this.getRenderedLayoutComponent(t,n);return s.append(i,r),s}getRenderedEngineControlComponent(t){const n=new e({classNames:["track__engine-control"]}),s=this.getRenderedStartEngineButton(t),i=this.getRenderedStopEngineButton(t);return n.append(s,i),this.unsubscriptionsEngineControl(t.id),this.subscriptionsEngineControl(s,i,t.id),n}unsubscriptionsEngineControl(e){this.eventEmitter.unsubscribe(`start-engine-button${e}: add disabled`),this.eventEmitter.unsubscribe(`start-engine-button${e}: remove disabled`),this.eventEmitter.unsubscribe(`stop-engine-button${e}: add disabled`),this.eventEmitter.unsubscribe(`stop-engine-button${e}: remove disabled`)}subscriptionsEngineControl(e,t,n){this.eventEmitter.subscribe(`start-engine-button${n}: add disabled`,(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe(`start-engine-button${n}: remove disabled`,(()=>{e.removeAttributes(["disabled"])})),this.eventEmitter.subscribe(`stop-engine-button${n}: add disabled`,(()=>{t.setAttributes({disabled:""})})),this.eventEmitter.subscribe(`stop-engine-button${n}: remove disabled`,(()=>{t.removeAttributes(["disabled"])}))}getRenderedStartEngineButton(e){const t=this.createButtonComponent("A",["track__engine-control-btn-start","btn","btn_engine","btn_engine_start"]);return this.handleStartEngineButtonListener(t,e.id),this.unsubscriptionsStartEngineButton(e.id),this.subscriptionsStartEngineButton(e.id),t}unsubscriptionsStartEngineButton(e){this.eventEmitter.unsubscribe(`start-engine-button${e}: start`)}subscriptionsStartEngineButton(e){this.eventEmitter.subscribe(`start-engine-button${e}: start`,(async()=>{this.eventEmitter.emit(`start-engine-button${e}: add disabled`);const t=await C(e,r.started);this.eventEmitter.emit(`start-engine-button${e}: start animation`,JSON.stringify(t)),x.push(e);const n=A(e);this.eventEmitter.emit(`stop-engine-button${e}: remove disabled`),n.then((t=>{t.success||this.eventEmitter.emit(`car-animation${e}: cancel`,r.started)}))}))}getRenderedStopEngineButton(e){const t=this.createButtonComponent("B",["track__engine-control-btn-stop","btn","btn_engine","btn_engine_stop"],{disabled:""});return this.handleStopEngineButtonListener(t,e.id),this.unsubscriptionsStopEngineButton(e.id),this.subscriptionsStopEngineButton(e.id),t}unsubscriptionsStopEngineButton(e){this.eventEmitter.unsubscribe(`stop-engine-button${e}: stop`)}subscriptionsStopEngineButton(e){this.eventEmitter.subscribe(`stop-engine-button${e}: stop`,(async()=>{this.eventEmitter.emit(`stop-engine-button${e}: add disabled`),await C(e,r.stopped);const t=x.filter((t=>t!==e));x.length=0,x.push(...t),this.eventEmitter.emit(`car-animation${e}: cancel`,r.stopped),this.eventEmitter.emit(`start-engine-button${e}: remove disabled`),this.eventEmitter.emit(`remove-button${e}: remove disabled`),this.eventEmitter.emit(`select-button${e}: remove disabled`),x.length||(this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("create-button: remove disabled"),this.eventEmitter.emit("generate-button: remove disabled"),this.eventEmitter.emit("garage-pagination-next: remove disabled"),this.eventEmitter.emit("garage-pagination-prev: remove disabled"),this.eventEmitter.emit("reset-button: add disabled"))}))}getRenderedLayoutComponent(t,n){const s=new e({classNames:["track__layout"]}),i=this.getRenderedSVGComponent(t.color),r=new e({tagName:"img",classNames:["track__finish-img"],attributes:{src:"./img/finish.png",alt:"finish"}});return s.getNode().append(i.getNode()),s.append(r),this.unsubscriptionsLayout(t.id),this.subscriptionsLayout(t,i,n),s}unsubscriptionsLayout(e){this.eventEmitter.unsubscribe(`race-button${e}: start animation`),this.eventEmitter.unsubscribe(`start-engine-button${e}: start animation`)}subscriptionsLayout(e,t,n){this.eventEmitter.subscribe(`race-button${e.id}: start animation`,(async s=>{if(s){const{velocity:i,distance:r}=JSON.parse(s);this.startCarAnimation(e,t,n,{velocity:i,distance:r},!0)}})),this.eventEmitter.subscribe(`start-engine-button${e.id}: start animation`,(s=>{if(s){const{velocity:i,distance:r}=JSON.parse(s);this.startCarAnimation(e,t,n,{velocity:i,distance:r},!1)}}))}getRenderedSVGComponent(e){const t=new P({tagName:"svg",xmlns:O.xmlns,classNames:O.classNames,attributes:O.attributes}),n=new P({tagName:"path",xmlns:O.xmlns,attributes:{...O.path.attributes,fill:`${e}`}});return t.append(n),t}handleStartEngineButtonListener(e,t){e.addListener("click",(()=>{this.eventEmitter.emit("race-button: add disabled"),this.eventEmitter.emit("generate-button: add disabled"),this.eventEmitter.emit("update-form-field: lock"),this.eventEmitter.emit(`remove-button${t}: add disabled`),this.eventEmitter.emit(`select-button${t}: add disabled`),this.eventEmitter.emit(`start-engine-button${t}: start`)}))}handleStopEngineButtonListener(e,t){e.addListener("click",(()=>{this.eventEmitter.emit(`stop-engine-button${t}: stop`)}))}createButtonComponent(t,n,s){return new e({tagName:"button",classNames:n,textContent:t,attributes:{...s,type:"button"}})}startCarAnimation(e,t,n,{distance:s,velocity:i},a){const o=s/i,d=t.getNode(),c=d.getBoundingClientRect().width,m=n.getNode().getBoundingClientRect().width-c;let u,l=null;const b=t=>{l||(l=t);const n=t-l,s=Math.min(m/o*n,m);d.style.transform=`translateX(${s}px)`;const i=(t-l)/o;this.isWinner(s,m)&&(a&&this.showRaceResults(e,o),this.eventEmitter.emit("reset-button: remove disabled")),i<1&&(u=requestAnimationFrame(b))};u=requestAnimationFrame(b),this.eventEmitter.unsubscribe(`car-animation${e.id}: cancel`),this.eventEmitter.subscribe(`car-animation${e.id}: cancel`,(e=>{e===r.stopped&&(d.style.transform="translateX(0px)"),cancelAnimationFrame(u)}))}isWinner(e,t){return e===t&&!o.winner}getWinnerDataJSON(e,t){return JSON.stringify({carName:e.name,time:this.getWinnerTime(t)})}getWinnerTime(e){return Number((e/1e3).toFixed(2))}showRaceResults(e,t){o.winner=!0,this.openPopup(o.winner,e,t);const n={id:e.id,time:this.getWinnerTime(t)};this.eventEmitter.emit("leaderboard: add winner",JSON.stringify(n))}openPopup(e,t,n){if(e){const e=this.getWinnerDataJSON(t,n);this.eventEmitter.emit("popup: open",e)}}}const M="PREV",G="NEXT",W=["pagination__btn-prev","btn"],V=["pagination__btn-next","btn"];class j extends e{constructor(e,t){super({classNames:["pagination"]}),this.eventEmitter=e,this.winnersInfo=t,this.render(),this.setVisibility(this),this.eventEmitter.subscribe("leaderboard-pagination: rerender",(e=>this.rerender(e))),this.eventEmitter.subscribe("leaderboard-pagination: set visibility",(()=>this.setVisibility(this)))}setVisibility(e){e.getNode().style.display=o.currentPage===i.leaderboard?"block":"none"}rerender(e){e&&(this.winnersInfo=JSON.parse(e),this.destroyChildren(),this.render())}render(){const e=this.createButtonComponent(M,W),t=this.createButtonComponent(G,V),n=this.createPageCounterComponent();this.handlePrevButtonListener(e),this.handleNextButtonListener(t),this.append(e,n,t)}handlePrevButtonListener(e){e.addListener("click",(async()=>{if(o.currentLeaderboardPage>1){o.currentLeaderboardPage-=1;const e=await T();this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(e)),this.eventEmitter.emit("leaderboard-pagination: rerender",JSON.stringify(e))}}))}handleNextButtonListener(e){e.addListener("click",(async()=>{if(o.totalLeaderboardPages>o.currentLeaderboardPage){o.currentLeaderboardPage+=1;const e=await T();this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(e)),this.eventEmitter.emit("leaderboard-pagination: rerender",JSON.stringify(e))}}))}createButtonComponent(t,n){return new e({tagName:"button",classNames:n,textContent:t,attributes:{type:"button"}})}createPageCounterComponent(){return new e({tagName:"span",classNames:["pagination__page-counter"],textContent:this.getPageCounterTextContent(this.winnersInfo)})}setTotalWinnerPages(e){let t=Math.ceil(e/10);t||(t+=1),o.totalLeaderboardPages=t}getPageCounterTextContent(e){return this.setTotalWinnerPages(e.totalWinners),`${o.currentLeaderboardPage} / ${o.totalLeaderboardPages}`}}class F extends e{constructor(e,t){super({classNames:["pagination"]}),this.eventEmitter=e,this.carsInfo=t,this.render(),this.setVisibility(this),this.eventEmitter.subscribe("garage-pagination: rerender",(e=>this.rerender(e))),this.eventEmitter.subscribe("garage-pagination: set visibility",(()=>this.setVisibility(this)))}setVisibility(e){e.getNode().style.display=o.currentPage===i.garage?"block":"none"}rerender(e){e&&(this.carsInfo=JSON.parse(e),this.destroyChildren(),this.render())}render(){const e=this.createButtonComponent(M,W),t=this.createButtonComponent(G,V),n=this.createPageCounterComponent();this.append(e,n,t),this.handlePrevButtonListener(e),this.handleNextButtonListener(t),this.subscribersPrevButton(e),this.subscribersNextButton(t)}handlePrevButtonListener(e){e.addListener("click",(async()=>{if(o.currentGaragePage>1){o.currentGaragePage-=1,x.length=0;const e=await p();this.eventEmitter.emit("garage: rerender",JSON.stringify(e)),this.eventEmitter.emit("garage-pagination: rerender",JSON.stringify(e)),this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("create-button: remove disabled"),this.eventEmitter.emit("generate-button: remove disabled"),this.eventEmitter.emit("reset-button: add disabled")}}))}handleNextButtonListener(e){e.addListener("click",(async()=>{if(o.totalGaragePages>o.currentGaragePage){o.currentGaragePage+=1,x.length=0;const e=await p();this.eventEmitter.emit("garage: rerender",JSON.stringify(e)),this.eventEmitter.emit("garage-pagination: rerender",JSON.stringify(e)),this.eventEmitter.emit("race-button: remove disabled"),this.eventEmitter.emit("create-button: remove disabled"),this.eventEmitter.emit("generate-button: remove disabled"),this.eventEmitter.emit("reset-button: add disabled")}}))}subscribersPrevButton(e){this.eventEmitter.subscribe("garage-pagination-prev: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("garage-pagination-prev: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}subscribersNextButton(e){this.eventEmitter.subscribe("garage-pagination-next: add disabled",(()=>{e.setAttributes({disabled:""})})),this.eventEmitter.subscribe("garage-pagination-next: remove disabled",(()=>{e.removeAttributes(["disabled"])}))}createButtonComponent(t,n){return new e({tagName:"button",classNames:n,textContent:t,attributes:{type:"button"}})}createPageCounterComponent(){return new e({tagName:"span",classNames:["pagination__page-counter"],textContent:this.getPageCounterTextContent(this.carsInfo)})}setTotalCarPages(e){let t=Math.ceil(e/7);t||(t+=1),o.totalGaragePages=t}getPageCounterTextContent(e){return this.setTotalCarPages(e.totalCars),`${o.currentGaragePage} / ${o.totalGaragePages}`}}const U=["Number","Car","Name","Wins","Best time (s)"],H=["leaderboard-table__head-cell"],X=["leaderboard-table__row-cell"],D={classNames:["leaderboard-table__car-img","car-img","car-img_size_small"],...n};var Z=async e=>{try{const t=await fetch(`${h}/${e}`,{method:s.delete});return await t.json()}catch(e){return e}};var z=async e=>{const t=await fetch(`${l}/${e}`,{method:s.get});return await t.json()};var q=async e=>{const t=await fetch(h,{method:s.post,body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});return await t.json()};class K extends e{constructor(e,t,n){super({tagName:"section",classNames:["leaderboard-section"]}),this.eventEmitter=e,this.winnersInfo=t,this.winnersCarsInfo=n,this.render(),this.eventEmitter.subscribe("leaderboard: rerender",(async e=>this.rerender(e))),this.setVisibility(this),this.eventEmitter.subscribe("leaderboard: set visibility",(()=>this.setVisibility(this))),this.eventEmitter.subscribe("leaderboard: add winner",(async e=>{e&&this.addWinner(e)}))}async addWinner(e){const{id:t}=JSON.parse(e);let n,{time:s}=JSON.parse(e);try{const e=await S(t);if(!Object.keys(e).length)throw new Error;n=e.wins+1,e.time<s&&(s=e.time);const i=await $(t,{wins:n,time:s});if(!Object.keys(i).length)throw new Error}catch{n=1,await q({id:t,wins:n,time:s})}const i=await T();this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(i)),this.eventEmitter.emit("leaderboard-pagination: rerender",JSON.stringify(i))}setVisibility(e){e.getNode().style.display=o.currentPage===i.leaderboard?"block":"none"}render(){const e=this.getRenderedTitleComponent(),t=this.getRenderedTable();this.append(e,t)}async rerender(e){e&&(this.winnersInfo=JSON.parse(e),this.winnersCarsInfo=await this.getWinnersCarsInfo(this.winnersInfo),this.destroyChildren(),this.render())}async getWinnersCarsInfo(e){const{winners:t}=e;return await Promise.all(t.map((e=>z(e.id))))}getRenderedTitleComponent(){const t=new e({tagName:"h2",classNames:["leaderboard-section__title","section-title"],textContent:"Winners "});return t.append(this.createPostfixComponent()),t}createPostfixComponent(){return new e({tagName:"span",classNames:["section-title__postfix"],textContent:`[${this.winnersInfo.totalWinners}]`})}getRenderedTable(){const t=new e({tagName:"table",classNames:["leaderboard-section__table","leaderboard-table"]}),n=this.getRenderedTableBody();return t.append(n),t}getRenderedTableBody(){const t=new e({tagName:"tbody",classNames:["leaderboard-table__body"]}),n=this.getRenderedTableHead();t.append(n);const{winners:s}=this.winnersInfo;return t.append(...this.winnersCarsInfo.map(((e,t)=>{const n=t+1;return this.getRenderedTableRow(e.id,n,e.color,e.name,s[t].wins,s[t].time)}))),t}getRenderedTableHead(){const t=new e({tagName:"tr",classNames:["leaderboard-table__head"]}),n=[{},{},{},{id:"wins"},{id:"time"}];for(let e=0;e<5;e+=1){const s=this.getRenderedTableCell("TH",H,U[e],"",n[e]);Object.keys(n[e]).length&&this.handleTableCell(s,n[e].id),t.append(s)}return t}handleTableCell(e,t){e.addListener("click",(async()=>{let e="";"wins"===t?(o.sortedWins===a.asc?e=a.desc:o.sortedWins!==a.desc&&o.sortedWins||(e=a.asc),o.sortedWins=e):"time"===t&&(o.sortedTime===a.asc?e=a.desc:o.sortedTime!==a.desc&&o.sortedTime||(e=a.asc),o.sortedTime=e);const n=await T(t,e);this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(n))}))}getRenderedTableRow(t,n,s,i,r,a){const o=[n,"",i,r,a],d=["",s,"","",""],c=new e({tagName:"tr",classNames:["leaderboard-table__row"],attributes:{"data-id":`${t}`}}),m=new Array(5).fill(0).map(((e,t)=>this.getRenderedTableCell("TD",X,o[t],d[t])));return c.append(...m),this.eventEmitter.unsubscribe(`remove-button${t}: remove car from leaderboard`),this.eventEmitter.subscribe(`remove-button${t}: remove car from leaderboard`,(()=>{this.removeCar(c)})),c}async removeCar(e){const t=Number(e.getNode().dataset.id);await Z(t);let n=await T();!n.winners.length&&o.currentLeaderboardPage>1&&(o.currentLeaderboardPage-=1,n=await T()),this.eventEmitter.emit("leaderboard: rerender",JSON.stringify(n)),this.eventEmitter.emit("leaderboard-pagination: rerender",JSON.stringify(n))}getRenderedTableCell(t,n,s,i,r){const a=new e({tagName:t,classNames:n,textContent:String(s),attributes:r});if(i){const e=this.getRenderedSVGComponent(i);a.getNode().append(e.getNode())}return a}getRenderedSVGComponent(e){const t=new P({tagName:"svg",xmlns:D.xmlns,classNames:D.classNames,attributes:D.attributes}),n=new P({tagName:"path",xmlns:D.xmlns,attributes:{...D.path.attributes,fill:`${e}`}});return t.append(n),t}}class Y extends e{constructor(e){super({tagName:"main",classNames:["main","container"]}),this.eventEmitter=e,this.render(),this.eventEmitter.subscribe("main: render",(()=>this.render()))}async render(){const e=await p(),t=await T(),n=await this.getWinnersCarsInfo(t),s=new k(this.eventEmitter,e),i=new I(this.eventEmitter,e),r=new K(this.eventEmitter,t,n),a=new F(this.eventEmitter,e),o=new j(this.eventEmitter,t);this.append(s,i,a,r,o)}async getWinnersCarsInfo(e){const{winners:t}=e,n=[];for(let e=0;e<t.length;e+=1)n.push(z(t[e].id));return await Promise.all(n)}}class Q extends e{constructor(){super({tagName:"footer",classNames:["footer"]}),this.render()}render(){const t=new e({classNames:["footer__container","container"]}),n=new e({classNames:["footer__body"]}),s=this.getRenderedSchoolLinkComponent(),i=this.getRenderedTextComponent();this.append(t),t.append(n),n.append(s,i)}getRenderedTextComponent(){const t=new e({tagName:"p",classNames:["footer__text"],textContent:"Copyright © 2023 Made by "}),n=this.createLinkComponent("https://github.com/SadMearise");return t.append(n),t}getRenderedSchoolLinkComponent(){const t=this.createLinkComponent("https://rs.school/js/"),n=new e({tagName:"img",classNames:["footer__img"],attributes:{src:"./img/rsschool.svg",alt:"RS School",width:81..toString(),height:30..toString()}});return t.append(n),t}createLinkComponent(t){return new e({tagName:"a",classNames:["footer__link"],attributes:{target:"_blank",href:t}})}}class ee extends e{constructor(e){super({classNames:["wrapper"]}),this.eventEmitter=e,this.render()}render(){const e=new m(this.eventEmitter),t=new Y(this.eventEmitter),n=new Q;this.append(e,t,n)}}class te{constructor(){this.events={}}emit(e,t){const n=this.events[e];n&&n.forEach((e=>{e.call(null,t)}))}subscribe(e,t){this.events[e]||(this.events[e]=[]),this.events[e].includes(t)||this.events[e].push(t)}unsubscribe(e){this.events[e]&&(this.events[e]=[])}}(new class{constructor(){this.body=document.body}start(){const e=new te,n=new ee(e);this.body.prepend(n.getNode()),e.subscribe("popup: open",(e=>{if(e){const{carName:n,time:s}=JSON.parse(e),i=new t(n,s);this.body.append(i.getNode())}}))}}).start()}();